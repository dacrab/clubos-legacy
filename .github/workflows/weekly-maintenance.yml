# Weekly maintenance workflow for ClubOS
# Comprehensive health checks and maintenance reporting

name: üßπ Weekly Maintenance

on:
  schedule:
    # Run every Sunday at 1 AM UTC (non-conflicting time)
    - cron: '0 1 * * 0'
  workflow_dispatch: # Allow manual trigger

# Prevent conflicts with other workflows
concurrency:
  group: maintenance-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  issues: write
  pull-requests: read

env:
  BUN_VERSION: 1.2.20

jobs:
  # Comprehensive health and security audit
  health-audit:
    name: üè• Health & Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      health-score: ${{ steps.calculate-score.outputs.score }}
      issues-found: ${{ steps.calculate-score.outputs.issues }}

    steps:
      - name: üìÇ Checkout repository
        uses: actions/checkout@v4

      - name: üèóÔ∏è Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: üì¶ Install dependencies
        run: bun install --frozen-lockfile

      - name: üéØ TypeScript health check
        id: typescript-check
        run: |
          echo "## üéØ TypeScript Health Check" >> $GITHUB_STEP_SUMMARY
          if bun run type-check; then
            echo "typescript_healthy=true" >> $GITHUB_OUTPUT
            echo "‚úÖ TypeScript compilation successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "typescript_healthy=false" >> $GITHUB_OUTPUT
            echo "‚ùå TypeScript compilation issues detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: üîç Code quality assessment
        id: lint-check
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîç Code Quality Assessment" >> $GITHUB_STEP_SUMMARY
          if bun run lint; then
            echo "lint_healthy=true" >> $GITHUB_OUTPUT
            echo "‚úÖ No linting issues found" >> $GITHUB_STEP_SUMMARY
          else
            echo "lint_healthy=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Linting issues detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: üîí Security vulnerability scan
        id: security-scan
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîí Security Vulnerability Scan" >> $GITHUB_STEP_SUMMARY
          if bun audit --audit-level moderate; then
            echo "security_healthy=true" >> $GITHUB_OUTPUT
            echo "‚úÖ No security vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "security_healthy=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Security vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: üóÑÔ∏è Database schema validation
        id: db-check
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üóÑÔ∏è Database Schema Validation" >> $GITHUB_STEP_SUMMARY
          bun run db:generate
          if [ -z "$(git status --porcelain src/lib/db/migrations/)" ]; then
            echo "db_healthy=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Database schema is up to date" >> $GITHUB_STEP_SUMMARY
          else
            echo "db_healthy=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Database schema changes detected but not committed" >> $GITHUB_STEP_SUMMARY
          fi
        env:
          DATABASE_URL: 'postgresql://test:test@localhost:5432/test_db'

      - name: üìä Calculate health score
        id: calculate-score
        run: |
          # Calculate health score based on checks
          score=0
          issues=""

          if [ "${{ steps.typescript-check.outputs.typescript_healthy }}" = "true" ]; then
            score=$((score + 25))
          else
            issues="${issues}TypeScript compilation errors; "
          fi

          if [ "${{ steps.lint-check.outputs.lint_healthy }}" = "true" ]; then
            score=$((score + 25))
          else
            issues="${issues}Code quality issues; "
          fi

          if [ "${{ steps.security-scan.outputs.security_healthy }}" = "true" ]; then
            score=$((score + 25))
          else
            issues="${issues}Security vulnerabilities; "
          fi

          if [ "${{ steps.db-check.outputs.db_healthy }}" = "true" ]; then
            score=$((score + 25))
          else
            issues="${issues}Database schema issues; "
          fi

          echo "score=$score" >> $GITHUB_OUTPUT
          echo "issues=$issues" >> $GITHUB_OUTPUT

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìä Overall Health Score: $score/100" >> $GITHUB_STEP_SUMMARY

  # Performance and dependency analysis
  performance-analysis:
    name: üìà Performance & Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      build-time: ${{ steps.build-perf.outputs.build-time }}
      bundle-size: ${{ steps.build-perf.outputs.bundle-size }}
      dep-count: ${{ steps.dep-analysis.outputs.total-deps }}

    steps:
      - name: üìÇ Checkout repository
        uses: actions/checkout@v4

      - name: üèóÔ∏è Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: üì¶ Install dependencies
        run: bun install --frozen-lockfile

      - name: ‚ö° Build performance test
        id: build-perf
        run: |
          echo "## ‚ö° Build Performance Analysis" >> $GITHUB_STEP_SUMMARY

          START_TIME=$(date +%s)
          bun run build
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - START_TIME))

          echo "build-time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "- **Build time:** ${BUILD_TIME}s" >> $GITHUB_STEP_SUMMARY

          # Analyze bundle size
          if [ -d ".next/static" ]; then
            BUNDLE_SIZE=$(du -sh .next/static | awk '{print $1}')
            echo "bundle-size=$BUNDLE_SIZE" >> $GITHUB_OUTPUT
            echo "- **Bundle size:** $BUNDLE_SIZE" >> $GITHUB_STEP_SUMMARY
          else
            echo "bundle-size=unknown" >> $GITHUB_OUTPUT
          fi

          # Performance recommendations
          if [ "$BUILD_TIME" -lt 120 ]; then
            echo "‚úÖ Excellent build performance (< 2 minutes)" >> $GITHUB_STEP_SUMMARY
          elif [ "$BUILD_TIME" -lt 300 ]; then
            echo "‚ö†Ô∏è Acceptable build performance (< 5 minutes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Build performance needs attention (> 5 minutes)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: üìä Dependency analysis
        id: dep-analysis
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìä Dependency Analysis" >> $GITHUB_STEP_SUMMARY

          PROD_DEPS=$(jq '.dependencies | length' package.json)
          DEV_DEPS=$(jq '.devDependencies | length' package.json)
          TOTAL_DEPS=$((PROD_DEPS + DEV_DEPS))

          echo "total-deps=$TOTAL_DEPS" >> $GITHUB_OUTPUT

          echo "- **Production dependencies:** $PROD_DEPS" >> $GITHUB_STEP_SUMMARY
          echo "- **Development dependencies:** $DEV_DEPS" >> $GITHUB_STEP_SUMMARY
          echo "- **Total dependencies:** $TOTAL_DEPS" >> $GITHUB_STEP_SUMMARY

          # Check node_modules size
          if [ -d "node_modules" ]; then
            MODULES_SIZE=$(du -sh node_modules | awk '{print $1}')
            echo "- **node_modules size:** $MODULES_SIZE" >> $GITHUB_STEP_SUMMARY
          fi

          # Dependency health assessment
          if [ "$TOTAL_DEPS" -lt 50 ]; then
            echo "‚úÖ Lean dependency footprint" >> $GITHUB_STEP_SUMMARY
          elif [ "$TOTAL_DEPS" -lt 100 ]; then
            echo "‚ö†Ô∏è Moderate dependency count" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è High dependency count - consider audit" >> $GITHUB_STEP_SUMMARY
          fi

  # Create comprehensive maintenance report
  maintenance-report:
    name: üìã Maintenance Report
    runs-on: ubuntu-latest
    needs: [health-audit, performance-analysis]
    if: always()

    steps:
      - name: üìä Generate comprehensive report
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const date = new Date().toISOString().split('T')[0];
            const healthScore = '${{ needs.health-audit.outputs.health-score }}' || '0';
            const issues = '${{ needs.health-audit.outputs.issues-found }}' || 'None detected';
            const buildTime = '${{ needs.performance-analysis.outputs.build-time }}' || 'Unknown';
            const bundleSize = '${{ needs.performance-analysis.outputs.bundle-size }}' || 'Unknown';
            const depCount = '${{ needs.performance-analysis.outputs.dep-count }}' || 'Unknown';

            const healthStatus = needs['health-audit'].result;
            const perfStatus = needs['performance-analysis'].result;

            // Determine overall health
            const overallHealth = parseInt(healthScore) >= 75 ? 'üü¢ HEALTHY' : 
                                parseInt(healthScore) >= 50 ? 'üü° ATTENTION' : 'üî¥ CRITICAL';

            const body = `## üßπ Weekly Maintenance Report - ${date}

            ### üìä System Health Overview

            **Overall Health Score: ${healthScore}/100** ${overallHealth}

            | Component | Status | Details |
            |-----------|--------|---------|
            | Code Quality | ${healthStatus === 'success' ? '‚úÖ HEALTHY' : '‚ùå ISSUES'} | ${issues === 'None detected' ? 'All checks passed' : issues} |
            | Performance | ${perfStatus === 'success' ? '‚úÖ OPTIMAL' : '‚ö†Ô∏è REVIEW'} | Build: ${buildTime}s, Bundle: ${bundleSize} |
            | Dependencies | üì¶ ${depCount} total | Monitoring for updates via Renovate |

            ### üîß Maintenance Activities

            #### ‚úÖ Completed This Week
            - [x] Comprehensive health assessment
            - [x] Security vulnerability scan  
            - [x] Performance baseline measurement
            - [x] Dependency analysis
            - [x] Database schema validation

            #### üéØ Key Metrics
            - **Build Performance**: ${buildTime}s
            - **Bundle Size**: ${bundleSize}
            - **Total Dependencies**: ${depCount}
            - **Health Score**: ${healthScore}/100

            ### üìà Recommendations

            ${healthScore >= 75 ? 
              '‚úÖ **System is healthy** - Continue current maintenance schedule' :
              healthScore >= 50 ?
              '‚ö†Ô∏è **Some attention needed** - Review detected issues and address during next sprint' :
              'üö® **Immediate attention required** - Critical issues detected that should be addressed promptly'
            }

            ### üîÑ Automated Updates

            - **Renovate**: Managing dependency updates
            - **Kodiak**: Handling auto-merge for approved changes
            - **Formatting**: Scheduled code formatting maintenance

            ### üìÖ Next Steps

            1. Review any detected issues
            2. Monitor Renovate dependency PRs
            3. Next automated maintenance: ${new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}

            ---
            *Generated automatically by ClubOS maintenance workflow*
            *For questions or issues, contact @dacrab*`;

            // Create maintenance issue or update existing one
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['üßπ maintenance', 'üìä automated'],
              state: 'open'
            });

            if (issues.data.length > 0) {
              // Update existing maintenance issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
              
              // Update title to reflect current week
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                title: `üßπ Weekly Maintenance Report - ${date}`
              });
            } else {
              // Create new maintenance issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üßπ Weekly Maintenance Report - ${date}`,
                body: body,
                labels: ['üßπ maintenance', 'üìä automated', 'üìã report']
              });
            }

      - name: üìù Update workflow summary
        run: |
          echo "## üßπ Weekly Maintenance Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Comprehensive system health check completed" >> $GITHUB_STEP_SUMMARY
          echo "üìä Maintenance report generated and posted as issue" >> $GITHUB_STEP_SUMMARY
          echo "üîÑ Next maintenance scheduled for next Sunday" >> $GITHUB_STEP_SUMMARY
