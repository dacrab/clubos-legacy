# CI/CD Pipeline for ClubOS
# Comprehensive code quality checks including build, lint, format, and type checking

name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Code Quality Checks
  quality:
    name: ðŸ” Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.20

      - name: ðŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ðŸŽ¯ Type checking
        run: bun run type-check

      - name: ðŸ”§ ESLint check
        run: bun run lint

      - name: ðŸ’… Prettier format check
        run: bun run format:check

  # Job 2: Build Test
  build:
    name: ðŸ—ï¸ Build Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: quality

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.20

      - name: ðŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ðŸ”¨ Build application
        run: bun run build
        env:
          NODE_ENV: production

      - name: ðŸ“Š Bundle size analysis
        run: |
          echo "## ðŸ“¦ Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "Build completed successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          if [ -f ".next/analyze" ]; then
            echo "Bundle analysis files generated." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ’¾ Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
            .next/static
          key: build-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            build-${{ runner.os }}-

  # Job 3: Database Schema Validation
  database:
    name: ðŸ—„ï¸ Database Schema
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: quality

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.20

      - name: ðŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ðŸ”§ Generate Drizzle migrations
        run: bun run db:generate
        env:
          DATABASE_URL: 'postgresql://test:test@localhost:5432/test_db'

      - name: âœ… Validate schema changes
        run: |
          if [ -n "$(git status --porcelain src/lib/db/migrations/)" ]; then
            echo "âŒ Database schema changes detected but migrations not committed!"
            echo "Please run 'bun run db:generate' and commit the migration files."
            exit 1
          else
            echo "âœ… Database schema is up to date!"
          fi

  # Job 4: Security and Performance
  security:
    name: ðŸ›¡ï¸ Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request'

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.20

      - name: ðŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ðŸ” Audit dependencies
        run: bun audit --audit-level moderate

      - name: ðŸ” Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  # Job 5: Deployment Readiness
  deploy-ready:
    name: ðŸš€ Deploy Ready
    runs-on: ubuntu-latest
    needs: [quality, build, database]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: âœ… All checks passed
        run: |
          echo "ðŸŽ‰ All quality checks passed!" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Code quality: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build test: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Database schema: VALIDATED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ready for deployment! ðŸš€" >> $GITHUB_STEP_SUMMARY
