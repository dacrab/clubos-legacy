# Auto-merge workflow for ClubOS
# Automatically merges safe dependency updates after CI passes

name: ðŸ¤– Auto Merge Dependencies

on:
  pull_request_target:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

permissions:
  contents: write
  pull-requests: write
  checks: read
  statuses: read

jobs:
  # Job 1: Check if PR is eligible for auto-merge
  check-eligibility:
    name: ðŸ” Check Eligibility
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      eligible: ${{ steps.check.outputs.eligible }}
      pr-type: ${{ steps.check.outputs.pr-type }}

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Check PR eligibility
        id: check
        run: |
          # Check if PR is from Dependabot
          if [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
            echo "eligible=true" >> $GITHUB_OUTPUT
            
            # Determine PR type based on title/content
            if echo "${{ github.event.pull_request.title }}" | grep -qE "(patch|fix|security)"; then
              echo "pr-type=patch" >> $GITHUB_OUTPUT
            elif echo "${{ github.event.pull_request.title }}" | grep -qE "(minor|feature)"; then
              echo "pr-type=minor" >> $GITHUB_OUTPUT
            else
              echo "pr-type=major" >> $GITHUB_OUTPUT
            fi
            
            echo "âœ… Dependabot PR detected - eligible for auto-merge" >> $GITHUB_STEP_SUMMARY
          else
            echo "eligible=false" >> $GITHUB_OUTPUT
            echo "âŒ Not a Dependabot PR - skipping auto-merge" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 2: Wait for CI and perform safety checks
  safety-checks:
    name: ðŸ›¡ï¸ Safety Checks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: check-eligibility
    if: needs.check-eligibility.outputs.eligible == 'true'

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: â³ Wait for CI checks
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 30
          running-workflow-name: 'ðŸ›¡ï¸ Safety Checks'
          allowed-conclusions: success

      - name: ðŸ” Verify no breaking changes
        run: |
          echo "## ðŸ›¡ï¸ Safety Check Results" >> $GITHUB_STEP_SUMMARY

          # Check if this is a patch/security update (safer to auto-merge)
          if [[ "${{ needs.check-eligibility.outputs.pr-type }}" == "patch" ]]; then
            echo "âœ… **Patch/Security update** - Safe for auto-merge" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.check-eligibility.outputs.pr-type }}" == "minor" ]]; then
            echo "âš ï¸ **Minor update** - Proceeding with caution" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Major update** - Requires manual review" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # Job 3: Auto-merge the PR
  auto-merge:
    name: ðŸ”„ Auto Merge
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [check-eligibility, safety-checks]
    if: |
      needs.check-eligibility.outputs.eligible == 'true' &&
      (needs.check-eligibility.outputs.pr-type == 'patch' || 
       needs.check-eligibility.outputs.pr-type == 'minor')

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ¤– Enable auto-merge
        run: |
          # Use GitHub CLI to enable auto-merge
          gh pr merge "${{ github.event.pull_request.number }}" \
            --squash \
            --auto \
            --delete-branch \
            --subject "ðŸ¤– Auto-merge: ${{ github.event.pull_request.title }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“ Add success comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ¤– Auto-merge Enabled

              âœ… This PR has been automatically approved for merging because:

              - ðŸ” All CI checks passed
              - ðŸ›¡ï¸ Security scans completed successfully  
              - ðŸ“¦ Safe dependency update (${{ needs.check-eligibility.outputs.pr-type }})
              - ðŸ¤– Created by Dependabot

              The PR will be automatically merged once all status checks pass.

              ---
              *Auto-generated by ClubOS automation*`
            })

      - name: ðŸ“Š Update summary
        run: |
          echo "## ðŸŽ‰ Auto-merge Successful!" >> $GITHUB_STEP_SUMMARY
          echo "âœ… PR #${{ github.event.pull_request.number }} has been queued for auto-merge" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” Type: ${{ needs.check-eligibility.outputs.pr-type }} update" >> $GITHUB_STEP_SUMMARY
          echo "â° Will merge automatically when all checks pass" >> $GITHUB_STEP_SUMMARY
